function findAncestor(e,t){let i=e;for(;(i=i.parentElement)&&!i.hasAttribute(t););if(i instanceof HTMLElement)return i;for(i=e;(i=i.parentElement)&&!i.classList.contains(t););return i instanceof HTMLElement&&i}function getParent(e,t){let i=null;for(;null!=e.parentElement;){if(e.parentElement.matches(t)){i=e.parentElement;break}e=e.parentElement}return i}let launchIntoFullscreen=void 0,exitFullscreen=void 0;function doDeviceHaveTouch(){let e=!1;return("ontouchstart"in window||window.DocumentTouch)&&(e=!0),e}function resizeEvent(e,t){"remove"===t?(window.removeEventListener("resize",e,!0),window.removeEventListener("orientationchange",e)):(window.addEventListener("resize",e,!0),window.addEventListener("orientationchange",e))}function bind(e,...t){t.forEach(t=>{if(!e[t])return console.warn(`Method '${t}' does not exist on ${typeof e}:`,e);e[t]=e[t].bind(e)})}launchIntoFullscreen=function(e){console.log(e),document.fullscreenElement||e.requestFullscreen().catch(e=>{console.log(`Error attempting to enable full-screen mode: ${e.message} (${e.name})`)})},exitFullscreen=function(){document.fullscreenElement&&document.exitFullscreen().then(()=>console.log("Document Exited form Full screen mode")).catch(e=>console.error(e))};class Walnut{constructor(e){bind(this,"onDragPreviewList","onDragingPreviewList","onDragEndPreviewList","nextImage","prevImage","fixViewer","fullscreen","initFlexEvents","deinitFlexEvents","handleWrapperClick"),this.initUI(),this.ui.images=e,this.touch={start:{},startX:0,startY:0,end:0},this.listContainer={dragstartY:0,dragendY:0,lastY:0,draging:!1,translatedY:0,dragCanceled:!1},this.allowedTouchDistance=100,this.minTouchDistance=20;for(let e=0;e<this.ui.images.length;e++){const t=this.ui.images[e];t.classList.add("walnut-image"),t.setAttribute("data-walnut-image",e),t.addEventListener("click",e=>{this.openViewer(e)})}}initUI(){const e=document.getElementById("walnut-viewer");this.ui={images:[],wrapper:e,list:e.getElementsByClassName("walnut__list")[0],listContainer:e.getElementsByClassName("walnut__list-container")[0],listHandle:e.getElementsByClassName("walnut__list-handle")[0],box:e.getElementsByClassName("walnut__box")[0],mainImageContainer:e.getElementsByClassName("walnut__image-container")[0],fullscreenBtn:e.getElementsByClassName("walnut__fullscreen")[0],directionArrow:e.getElementsByClassName("walnut__direction-arrow")[0],directionLine:e.getElementsByClassName("walnut__direction-line")[0],mainImage:e.getElementsByClassName("walnut__image")[0],prevBtn:e.querySelector(".walnut__navigation.walnut__navigation--prev"),nextBtn:e.querySelector(".walnut__navigation.walnut__navigation--next"),closeBtn:e.getElementsByClassName("walnut-close")[0]}}initEvents(){const e=this.ui.wrapper;if(document.addEventListener("keyup",this.checkKeyPressed,!1),doDeviceHaveTouch()){const e=this.ui.mainImage;e.addEventListener("touch.start",this.swipeStart),e.addEventListener("touch.end",this.swipeEnd),e.addEventListener("touchmove",this.swipeMove)}else this.ui.nextBtn.addEventListener("click",this.nextImage),this.ui.prevBtn.addEventListener("click",this.prevImage);e.addEventListener("click",this.handleWrapperClick,!1)}deinitEvents(){if(document.removeEventListener("keyup",this.checkKeyPressed,!1),doDeviceHaveTouch()){const e=this.ui.mainImage;e.removeEventListener("touch.start",this.swipeStart),e.removeEventListener("touch.end",this.swipeEnd),e.removeEventListener("touchmove",this.swipeMove)}else this.ui.nextBtn.removeEventListener("click",this.nextImage),this.ui.prevBtn.removeEventListener("click",this.prevImage);this.ui.wrapper.removeEventListener("click",this.handleWrapperClick,!1)}handleWrapperClick(e){e.stopPropagation(),e.preventDefault();const t=e.target;if(t.isSameNode(this.ui.wrapper))this.clickWrapper(e);else if(t.matches(".walnut__item")){let e=t.getAttribute("data-walnut-source");this.changeImage(null,{source:e,target:t,index:parseInt(t.getAttribute("data-walnut-index")),container:null})}else t.isSameNode(this.ui.closeBtn)||findAncestor(t,"walnut-close")?this.closeViewer():(t.isSameNode(this.ui.fullscreenBtn)||getParent(t,".walnut__fullscreen"))&&this.fullscreen()}initFlexEvents(){document.addEventListener("keyup",this.checkKeyPressed),window.addEventListener("popstate",this.changeHistory),resizeEvent(this.fixViewer)}deinitFlexEvents(){document.removeEventListener("keyup",this.checkKeyPressed),window.removeEventListener("popstate",this.changeHistory),resizeEvent(this.fixViewer,"remove")}initOverviewList(){const e=this.ui.list,t=this.ui.images;if(e.innerHTML="",t.length>1)for(let i=0;i<t.length;i++){const n=document.createElement("li");n.className="walnut__item",n.style.backgroundImage=`url(${t[i].src})`,n.setAttribute("data-walnut-source",t[i].src),e.appendChild(n)}}fixListWidth(){let e=document.getElementsByClassName("walnut__item")[0].offsetWidth;document.getElementsByClassName("walnut__list")[0].style.width=this.ui.images.length*e+"px"}openViewer(e){const t=e.target;if(void 0===t)return;let i,n=parseInt(t.getAttribute("data-walnut-image")),s=this.ui.mainImage,a=this.ui.prevBtn,l=this.ui.nextBtn;const r=window.getComputedStyle(t,null);if(t.src)i=t.src;else{if("none"==r.backgroundImage)throw new Error("Couldn't find a image for element: "+t);i=r.backgroundImage.slice(4,-1).replace(/"/g,"")}s.src=i,this.activeIndex=n,document.body.classList.add("walnut--open");let c=this.ui.images.length;0===n&&n===c-1?(a.style.display="none",l.style.display="none"):0===n?(a.style.display="none",l.style.display=""):n===c-1?(l.style.display="none",a.style.display=""):(a.style.display="",l.style.display=""),this.initEvents(),this.initFlexEvents(),this.fixViewer(),this.ui.wrapper.classList.add("walnut__wrapper--open");history.pushState("walnut","walnut","")}closeViewer(){this.activeIndex=0,this.ui.mainImage.src="",this.ui.wrapper.classList.remove("walnut__wrapper--open"),document.body.classList.remove("walnut--open"),this.deinitEvents(),this.deinitFlexEvents(),this.fullscreen("exit"),"walnut"===history.state&&window.history.back()}changeImage(e,t={}){let i=0;const n=this.ui.prevBtn,s=this.ui.nextBtn,a=this.ui.mainImage,l=this.ui.images;if(void 0!==e&&null!==e){if(i=this.activeIndex,"next"===e&&i<l.length-1)i+=1;else{if(!("prev"===e&&i>0))return;i-=1}if(l[i]){let e="";l[i].src?e=l[i].src:"none"!=l[i].style.backgroundImage&&(e=l[i].style.backgroundImage.slice(4,-1).replace(/"/g,"")),a.src=e,this.activeIndex=i}}else t&&t.source&&(i=parseInt(t.index),a.src=t.source,this.activeIndex=i);0===i&&i===l.length-1?(n.style.display="none",s.style.display="none"):0===i?(n.style.display="none",s.style.display=""):i===l.length-1?(s.style.display="none",n.style.display=""):(n.style.display="",s.style.display=""),this.checkHeight()}fixViewer(){this.checkHeight(),document.getElementsByClassName(".walnut__item")[0]instanceof HTMLElement&&this.fixListWidth()}checkHeight(){let e=this.ui.box.offsetHeight,t=this.ui.wrapper;e>window.innerHeight?t.classList.add("walnut--align-top"):t.classList.remove("walnut--align-top")}checkKeyPressed(e){let t=e.keyCode;37===t?this.changeImage("prev"):39===t?this.changeImage("next"):27===t&&this.closeViewer()}clickWrapper(e){e.stopPropagation(),e.preventDefault(),this.closeViewer(this)}fullscreen(e=""){let t=this.ui.wrapper,i=this.ui.fullscreenBtn;"exit"===e?(exitFullscreen(),i.classList.remove("walnut__fullscreen--hidden")):(launchIntoFullscreen(t),i.classList.add("walnut__fullscreen--hidden"))}nextImage(){this.changeImage("next")}prevImage(){this.changeImage("prev")}onDragPreviewList(e){const t=e.target;this.clickTarget=t,t.matches(".walnut__list-handle")&&(e.preventDefault(),console.log("dragStart",e),this.listContainer.dragstartY=e.clientY,this.listContainer.draging=!0)}onDragingPreviewList(e){e.preventDefault();let t=parseFloat(e.clientY);this.listContainer.draging&&!this.listContainer.dragCanceled&&(t>this.listContainer.dragstartY+1||t<this.listContainer.dragstartY-1)&&window.requestAnimationFrame(()=>{let e=this.listContainer.dragstartY,i=this.listContainer.translatedY+(t-e);i<0?this.listContainer.dragCanceled=!0:(i=Math.min(100,i),console.log("drag",i),this.ui.listContainer.style.transform=`translate3d(0, ${i}px, 0)`)})}onDragEndPreviewList(e){}swipeStart(e){let t=e.changedTouches[0];this.touch.startX=parseInt(t.clientX),this.touch.startY=parseInt(t.clientY),e.preventDefault()}swipeMove(e){let t,i,n=e.changedTouches[0],s=parseInt(n.clientX),a=parseInt(n.clientY),l=this.activeIndex,r=this.ui.directionLine,c=this.ui.directionArrow;t=Math.abs(s-this.touch.startX),i=Math.abs(a-this.touch.startY),r.style.width=40+t+"px",this.touch.startX>s&&i<this.allowedTouchDistance&&l<this.ui.images.length-1?(r.classList.remove("walnut__direction-line--active-left"),r.classList.add("walnut__direction-line--active walnut__direction-line--active-right"),c.innerHTML=""):this.touch.startX>s&&i<this.allowedTouchDistance?(r.classList.remove("walnut__direction-line--active-left"),r.classList.add("walnut__direction-line--active walnut__direction-line--active-right"),c.innerHTML=""):this.touch.startX<s&&i<this.allowedTouchDistance&&l>0?(r.classList.remove("walnut__direction-line--active-right"),r.classList.add("walnut__direction-line--active walnut__direction-line--active-left"),c.innerHTML=""):this.touch.startX<s&&i<this.allowedTouchDistance?(r.classList.remove("walnut__direction-line--active-right"),r.classList.add("walnut__direction-line--active walnut__direction-line--active-left"),c.innerHTML=""):r.classList.remove("walnut__direction-line--active walnut__direction-line--active-left walnut__direction-line--active-right"),e.preventDefault()}swipeEnd(e){let t=e.changedTouches[0],i=parseInt(t.clientX),n=parseInt(t.clientY),s=Math.abs(n-this.touch.startY),a=Math.abs(i-this.touch.startX),l=this.ui.directionLine;this.touch.end=i,e.preventDefault(),l.classList.remove("walnut__direction-line--active"),l.classList.remove("walnut__direction-line--active-left"),l.classList.remove("walnut__direction-line--active-right"),this.touch.startX>this.touch.end&&a>this.minTouchDistance&&s<this.allowedTouchDistance?this.nextImage():this.touch.startX<this.touch.end&&a>this.minTouchDistance&&s<this.allowedTouchDistance?this.prevImage():s>200&&this.closeViewer()}changeHistory(e){this.closeViewer()}}export default Walnut;
